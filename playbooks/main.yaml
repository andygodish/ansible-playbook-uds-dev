---
- name: Bootstrap - install Docker
  hosts: all
  gather_facts: true
  become: true

  # Role: https://galaxy.ansible.com/ui/standalone/roles/geerlingguy/docker/
  roles:
    - role: geerlingguy.docker
  vars:
    # Install Docker CE + plugins (buildx + compose) from Docker's official apt repo.
    docker_install_compose_plugin: true
    docker_install_compose: false
    docker_install_buildx_plugin: true
    docker_users:
      - "{{ ansible_user_id }}"

- name: Smoke test + basic report
  hosts: all
  gather_facts: true
  become: false

  vars:
    artifacts_dir: "{{ playbook_dir }}/../artifacts"
    remote_report_dir: "/tmp/ansible-artifacts"

  pre_tasks:
    - name: Ensure remote report directory exists
      ansible.builtin.file:
        path: "{{ remote_report_dir }}"
        state: directory
        mode: "0755"

  tasks:
    - name: Sanity check - ping
      ansible.builtin.ping:

    - name: Show a short summary
      ansible.builtin.debug:
        msg:
          hostname: "{{ ansible_hostname }}"
          os: "{{ ansible_distribution }} {{ ansible_distribution_version }}"
          arch: "{{ ansible_architecture }}"
          python: "{{ ansible_python_version | default('unknown') }}"

    - name: Write facts report on remote
      ansible.builtin.copy:
        dest: "{{ remote_report_dir }}/report.yaml"
        mode: "0644"
        content: |
          generated_at: {{ ansible_date_time.iso8601 }}
          host:
            hostname: {{ ansible_hostname }}
            fqdn: {{ ansible_fqdn }}
            user_id: {{ ansible_user_id }}
          os:
            distribution: {{ ansible_distribution }}
            version: {{ ansible_distribution_version }}
            kernel: {{ ansible_kernel }}

    - name: Disk usage (human readable)
      ansible.builtin.command: df -h
      register: df_out
      changed_when: false

    - name: Write disk usage on remote
      ansible.builtin.copy:
        dest: "{{ remote_report_dir }}/df.txt"
        mode: "0644"
        content: "{{ df_out.stdout }}\n"

    - name: Fetch reports back to controller artifacts/
      ansible.builtin.fetch:
        src: "{{ remote_report_dir }}/{{ item }}"
        dest: "{{ artifacts_dir }}/"
        flat: true
      loop:
        - report.yaml
        - df.txt
