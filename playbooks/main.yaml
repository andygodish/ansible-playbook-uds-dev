---
- name: Bootstrap - install Docker
  hosts: all
  gather_facts: true
  become: true

  vars:
    k3d_version: "v5.8.3"
    uds_cli_version: "v0.28.2"
    gh_version: "2.87.2"

    # Git defaults (global)
    git_user_name: "Andy Godish"
    # Default noreply email (override with -e git_user_email=... if you use the numeric-id form)
    git_user_email: "{{ ansible_user }}@users.noreply.github.com"
    git_init_default_branch: "main"
    git_pull_rebase: false

    # Docker NFS volume (for uds-k3d persistence)
    uds_nfs_volume_name: "uds-dev-nfs"
    uds_nfs_server: "192.168.1.55"
    uds_nfs_export: "/uds-dev"
    uds_nfs_version: "4"

    # For testing repo clone task (override as needed)
    repos_to_clone:
      - "git@github.com:andygodish/package-k3d.git"

  pre_tasks:
    - name: Fix netplan DHCP/DNS (Proxmox template stale MAC match)
      ansible.builtin.import_tasks: tasks/fix-netplan-dhcp.yaml

  # Role: https://galaxy.ansible.com/ui/standalone/roles/geerlingguy/docker/
  roles:
    - role: geerlingguy.docker
      vars:
        docker_users:
          - "{{ ansible_user }}"

  tasks:
    - name: Configure git defaults
      ansible.builtin.import_tasks: tasks/configure-git.yaml
      tags:
        - git-config

    - name: Install k3d
      ansible.builtin.import_tasks: tasks/install-k3d.yaml

    - name: Install UDS CLI (pinned)
      ansible.builtin.import_tasks: tasks/install-uds-cli.yaml

    - name: Install gh (pinned)
      ansible.builtin.import_tasks: tasks/install-gh.yaml
      tags:
        - gh

    - name: Clone repos (optional)
      ansible.builtin.import_tasks: tasks/clone-repos.yaml
      when: repos_to_clone is defined
      tags:
        - clone-repos

  post_tasks:
    - name: Create Docker NFS volume for uds-k3d persistence (optional)
      ansible.builtin.import_tasks: tasks/create-docker-nfs-volume.yaml
      tags:
        - nfs-volume
