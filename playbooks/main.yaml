---
- name: Bootstrap - install Docker
  hosts: all
  gather_facts: true
  become: true

  vars:
    k3d_version: "v5.8.3"
    uds_cli_version: "v0.28.2"

    # Docker NFS volume (for uds-k3d persistence)
    uds_nfs_volume_name: "uds-local-nfs"
    uds_nfs_server: "192.168.1.55"
    uds_nfs_export: "/uds-local"
    uds_nfs_version: "4"

    # For testing repo clone task (override as needed)
    repos_to_clone:
      - "https://github.com/andygodish/package-k3d.git"

  pre_tasks:
    - name: Fix netplan DHCP/DNS (Proxmox template stale MAC match)
      ansible.builtin.import_tasks: tasks/fix-netplan-dhcp.yaml

  # Role: https://galaxy.ansible.com/ui/standalone/roles/geerlingguy/docker/
  roles:
    - role: geerlingguy.docker
      vars:
        docker_users:
          - "{{ ansible_user }}"

  tasks:
    - name: Install k3d
      ansible.builtin.import_tasks: tasks/install-k3d.yaml

    - name: Install UDS CLI (pinned)
      ansible.builtin.import_tasks: tasks/install-uds-cli.yaml

    - name: Clone repos (optional)
      ansible.builtin.import_tasks: tasks/clone-repos.yaml
      when: repos_to_clone is defined
      tags:
        - clone-repos

  post_tasks:
    # Optional: create a Docker NFS volume used by uds-k3d persistence.
    # This mirrors the manual pattern from package-k3d/docs/nfs-persistence.md.
    - name: Check if Docker volume exists ({{ uds_nfs_volume_name }})
      ansible.builtin.command: docker volume inspect {{ uds_nfs_volume_name }}
      register: uds_nfs_volume_inspect
      failed_when: false
      changed_when: false

    - name: Create Docker NFS volume ({{ uds_nfs_volume_name }})
      ansible.builtin.command: >-
        docker volume create --driver local
        --opt type=nfs
        --opt o=addr={{ uds_nfs_server }},nfsvers={{ uds_nfs_version }},rw
        --opt device=:{{ uds_nfs_export }}
        {{ uds_nfs_volume_name }}
      when: uds_nfs_volume_inspect.rc != 0
      register: uds_nfs_volume_create
      changed_when: true

    - name: Show Docker NFS volume details
      ansible.builtin.command: docker volume inspect {{ uds_nfs_volume_name }}
      register: uds_nfs_volume_inspect_after
      changed_when: false

    - name: Debug Docker NFS volume inspect
      ansible.builtin.debug:
        var: uds_nfs_volume_inspect_after.stdout
