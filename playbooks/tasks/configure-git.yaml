---
# Configure git defaults for this machine.
#
# Vars (set in playbooks/main.yaml):
# - git_user_name
# - git_user_email
# - git_init_default_branch
# - git_pull_rebase
# - git_signing_format
# - git_commit_gpgsign
# - git_user_signingkey

- name: Ensure git is installed (Ubuntu)
  ansible.builtin.apt:
    name: git
    state: present
    update_cache: true
  become: true

- name: Lookup home directory for ansible_user
  ansible.builtin.getent:
    database: passwd
    key: "{{ ansible_user }}"
  become: true

- name: Set gitconfig home
  ansible.builtin.set_fact:
    _git_home: "{{ getent_passwd[ansible_user][4] }}"

- name: Set git user.name (as ansible_user)
  ansible.builtin.command: git config --global user.name "{{ git_user_name }}"
  become: false
  environment:
    HOME: "{{ _git_home }}"
  changed_when: false

- name: Set git user.email (as ansible_user)
  ansible.builtin.command: git config --global user.email "{{ git_user_email }}"
  become: false
  environment:
    HOME: "{{ _git_home }}"
  changed_when: false

- name: Set git init.defaultBranch (as ansible_user)
  ansible.builtin.command: git config --global init.defaultBranch "{{ git_init_default_branch }}"
  become: false
  environment:
    HOME: "{{ _git_home }}"
  changed_when: false

- name: Set git pull.rebase (as ansible_user)
  ansible.builtin.command: git config --global pull.rebase "{{ git_pull_rebase | string }}"
  become: false
  environment:
    HOME: "{{ _git_home }}"
  changed_when: false

- name: Set git gpg.format (as ansible_user)
  ansible.builtin.command: git config --global gpg.format "{{ git_signing_format }}"
  become: false
  environment:
    HOME: "{{ _git_home }}"
  changed_when: false

- name: Set git commit.gpgsign (as ansible_user)
  ansible.builtin.command: git config --global commit.gpgsign "{{ git_commit_gpgsign | string }}"
  become: false
  environment:
    HOME: "{{ _git_home }}"
  changed_when: false

- name: Check signing public key exists
  ansible.builtin.stat:
    path: "{{ git_user_signingkey }}"
  register: git_signingkey_stat
  changed_when: false

- name: Set git user.signingkey (as ansible_user)
  ansible.builtin.command: git config --global user.signingkey "{{ git_user_signingkey }}"
  become: false
  environment:
    HOME: "{{ _git_home }}"
  when: git_signingkey_stat.stat.exists
  changed_when: false

- name: Warn if signing public key is missing
  ansible.builtin.debug:
    msg: "Skipping user.signingkey because {{ git_user_signingkey }} does not exist on the target yet. Generate or copy the public key, then re-run --tags git-config."
  when: not git_signingkey_stat.stat.exists

- name: Show git identity (as ansible_user)
  ansible.builtin.command: git config --global --list
  become: false
  environment:
    HOME: "{{ _git_home }}"
  register: git_config_out
  changed_when: false

- name: Debug git global config
  ansible.builtin.debug:
    var: git_config_out.stdout
